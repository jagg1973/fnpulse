<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= mode==='create' ? 'New' : 'Edit' %> Page - FNPulse Admin
    </title>
    <link rel="stylesheet" href="/public/css/admin.css">
</head>

<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>FNPulse</h2>
                <p>Admin Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/articles" class="nav-item">
                    <span class="icon">üìù</span>
                    <span>Articles</span>
                </a>
                <a href="/news" class="nav-item">
                    <span class="icon">üóûÔ∏è</span>
                    <span>News</span>
                </a>
                <a href="/press-releases" class="nav-item">
                    <span class="icon">üì¢</span>
                    <span>Press Releases</span>
                </a>
                <a href="/pages" class="nav-item active">
                    <span class="icon">üìÑ</span>
                    <span>Pages</span>
                </a>
                <a href="/authors" class="nav-item">
                    <span class="icon">üë§</span>
                    <span>Authors</span>
                </a>
                <a href="/ads" class="nav-item">
                    <span class="icon">üì¢</span>
                    <span>Ad Banners</span>
                </a>
                <a href="/images" class="nav-item">
                    <span class="icon">üñºÔ∏è</span>
                    <span>Images</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="/site-assets/index.html" target="_blank" class="btn-preview">
                    <span class="icon">üëÅÔ∏è</span>
                    Preview Site
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <div>
                    <a href="/pages" class="back-link">‚Üê Back to Pages</a>
                    <h1>
                        <%= mode==='create' ? 'Create New' : 'Edit' %> Page
                    </h1>
                </div>
                <div class="header-actions">
                    <button type="button" onclick="savePage()" class="btn btn-primary">Save Page</button>
                </div>
            </header>

            <form id="pageForm" class="article-form">
                <div class="form-section">
                    <h3>Page Details</h3>

                    <div class="form-group">
                        <label for="filename">Filename *</label>
                        <input type="text" id="filename" name="filename" class="form-control" placeholder="about.html"
                            value="<%= pageData && pageData.filename ? pageData.filename : '' %>" <%=mode==='edit'
                            ? 'readonly' : '' %> required>
                        <small>Use lowercase and end with .html</small>
                    </div>
                </div>

                <div class="form-section">
                    <div class="editor-header">
                        <div>
                            <h3>Page Content</h3>
                            <p class="helper-text">Switch between raw HTML and a rendered preview.</p>
                        </div>
                        <div class="editor-tabs" role="tablist" aria-label="Editor views">
                            <button type="button" class="editor-tab is-active" data-editor-view="code" role="tab"
                                aria-selected="true">HTML</button>
                            <button type="button" class="editor-tab" data-editor-view="split" role="tab"
                                aria-selected="false">Split</button>
                            <button type="button" class="editor-tab" data-editor-view="preview" role="tab"
                                aria-selected="false">Preview</button>
                        </div>
                    </div>

                    <div class="page-editor" data-editor-view-container>
                        <div class="editor-pane editor-pane-code">
                            <label class="sr-only" for="html">Page HTML</label>
                            <textarea id="html" name="html" class="form-control editor-textarea" rows="18"
                                style="font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;"><%- pageData && pageData.html ? pageData.html : '' %></textarea>
                        </div>
                        <div class="editor-pane editor-pane-preview">
                            <div class="preview-toolbar">
                                <span class="preview-label">Live Preview</span>
                                <button type="button" class="btn btn-secondary btn-small"
                                    id="refreshPreview">Refresh</button>
                            </div>
                            <iframe id="pagePreview" title="Page preview"
                                sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
                        </div>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <script src="/public/js/admin.js"></script>
    <script>
        const editorTabs = document.querySelectorAll('[data-editor-view]');
        const editorContainer = document.querySelector('[data-editor-view-container]');
        const htmlInput = document.getElementById('html');
        const previewFrame = document.getElementById('pagePreview');
        const refreshBtn = document.getElementById('refreshPreview');

        function setEditorView(view) {
            if (!editorContainer) return;
            editorContainer.dataset.view = view;
            editorTabs.forEach(tab => {
                const isActive = tab.dataset.editorView === view;
                tab.classList.toggle('is-active', isActive);
                tab.setAttribute('aria-selected', String(isActive));
            });
            if (view !== 'code') {
                updatePreview();
            }
        }

        function injectBaseTag(html) {
            if (!html) return '';
            if (/<base\s/i.test(html)) return html;
            if (/<head[^>]*>/i.test(html)) {
                return html.replace(/<head([^>]*)>/i, '<head$1><base href="/site-assets/">');
            }
            return `<base href="/site-assets/">${html}`;
        }

        let previewTimer;
        function updatePreview() {
            if (!previewFrame || !htmlInput) return;
            const raw = htmlInput.value || '';
            const withBase = injectBaseTag(raw);
            previewFrame.srcdoc = withBase;
        }

        editorTabs.forEach(tab => {
            tab.addEventListener('click', () => setEditorView(tab.dataset.editorView));
        });

        if (htmlInput) {
            htmlInput.addEventListener('input', () => {
                if (editorContainer?.dataset.view === 'code') return;
                clearTimeout(previewTimer);
                previewTimer = setTimeout(updatePreview, 400);
            });
        }

        if (refreshBtn) {
            refreshBtn.addEventListener('click', updatePreview);
        }

        setEditorView('code');

        async function savePage() {
            const form = document.getElementById('pageForm');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            if (!data.filename) {
                alert('Please provide a filename.');
                return;
            }

            const mode = '<%= mode %>';
            const url = mode === 'create' ? '/api/pages' : `/api/pages/${data.filename}`;
            const method = mode === 'create' ? 'POST' : 'PUT';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Page saved successfully!');
                    window.location.href = '/pages';
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
    </script>
</body>

</html>