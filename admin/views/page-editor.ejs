<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= mode==='create' ? 'New' : 'Edit' %> Page - FNPulse Admin
    </title>
    <link rel="stylesheet" href="/public/css/admin.css">
</head>

<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>FNPulse</h2>
                <p>Admin Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/articles" class="nav-item">
                    <span class="icon">üìù</span>
                    <span>Articles</span>
                </a>
                <a href="/news" class="nav-item">
                    <span class="icon">üóûÔ∏è</span>
                    <span>News</span>
                </a>
                <a href="/press-releases" class="nav-item">
                    <span class="icon">üì¢</span>
                    <span>Press Releases</span>
                </a>
                <a href="/pages" class="nav-item active">
                    <span class="icon">üìÑ</span>
                    <span>Pages</span>
                </a>
                <a href="/authors" class="nav-item">
                    <span class="icon">üë§</span>
                    <span>Authors</span>
                </a>
                <a href="/ads" class="nav-item">
                    <span class="icon">üì¢</span>
                    <span>Ad Banners</span>
                </a>
                <a href="/images" class="nav-item">
                    <span class="icon">üñºÔ∏è</span>
                    <span>Images</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="/site-assets/index.html" target="_blank" class="btn-preview">
                    <span class="icon">üëÅÔ∏è</span>
                    Preview Site
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <div>
                    <a href="/pages" class="back-link">‚Üê Back to Pages</a>
                    <h1>
                        <%= mode==='create' ? 'Create New' : 'Edit' %> Page
                    </h1>
                </div>
                <div class="header-actions">
                    <button type="button" onclick="savePage()" class="btn btn-primary">Save Page</button>
                </div>
            </header>

            <form id="pageForm" class="article-form">
                <div class="form-section">
                    <h3>Page Details</h3>

                    <div class="form-group">
                        <label for="filename">Filename *</label>
                        <input type="text" id="filename" name="filename" class="form-control" placeholder="about.html"
                            value="<%= pageData && pageData.filename ? pageData.filename : '' %>" <%=mode==='edit'
                            ? 'readonly' : '' %> required>
                        <small>Use lowercase and end with .html</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Images</h3>

                    <div class="form-group">
                        <label>Upload Images</label>
                        <div class="image-input-group">
                            <input type="file" id="pageImageUpload" accept="image/*" multiple style="display: none;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('pageImageUpload').click()">Upload</button>
                            <button type="button" class="btn btn-secondary" onclick="loadPageImages()">Refresh</button>
                        </div>
                        <small>Upload images here and click an image below to insert it into the HTML editor.</small>
                    </div>

                    <div class="upload-progress" id="pageUploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="pageProgressFill"></div>
                        </div>
                        <p id="pageProgressText">Uploading...</p>
                    </div>

                    <div id="pageImageGrid" class="image-grid"></div>
                </div>

                <div class="form-section">
                    <div class="editor-header">
                        <div>
                            <h3>Page Content</h3>
                            <p class="helper-text">Switch between raw HTML and a rendered preview.</p>
                        </div>
                        <div class="editor-tabs" role="tablist" aria-label="Editor views">
                            <button type="button" class="editor-tab is-active" data-editor-view="code" role="tab"
                                aria-selected="true">HTML</button>
                            <button type="button" class="editor-tab" data-editor-view="split" role="tab"
                                aria-selected="false">Split</button>
                            <button type="button" class="editor-tab" data-editor-view="preview" role="tab"
                                aria-selected="false">Preview</button>
                        </div>
                    </div>

                    <div class="page-editor" data-editor-view-container>
                        <div class="editor-pane editor-pane-code">
                            <label class="sr-only" for="html">Page HTML</label>
                            <textarea id="html" name="html" class="form-control editor-textarea" rows="18"
                                style="font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;"><%- pageData && pageData.html ? pageData.html : '' %></textarea>
                        </div>
                        <div class="editor-pane editor-pane-preview">
                            <div class="preview-toolbar">
                                <span class="preview-label">Live Preview</span>
                                <button type="button" class="btn btn-secondary btn-small"
                                    id="refreshPreview">Refresh</button>
                            </div>
                            <iframe id="pagePreview" title="Page preview"
                                sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
                        </div>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <script src="/public/js/admin.js"></script>
    <script>
        const editorTabs = document.querySelectorAll('[data-editor-view]');
        const editorContainer = document.querySelector('[data-editor-view-container]');
        const htmlInput = document.getElementById('html');
        const previewFrame = document.getElementById('pagePreview');
        const refreshBtn = document.getElementById('refreshPreview');
        const pageImageUploadInput = document.getElementById('pageImageUpload');
        const pageImageGrid = document.getElementById('pageImageGrid');
        const pageUploadProgress = document.getElementById('pageUploadProgress');
        const pageProgressFill = document.getElementById('pageProgressFill');
        const pageProgressText = document.getElementById('pageProgressText');

        function setEditorView(view) {
            if (!editorContainer) return;
            editorContainer.dataset.view = view;
            editorTabs.forEach(tab => {
                const isActive = tab.dataset.editorView === view;
                tab.classList.toggle('is-active', isActive);
                tab.setAttribute('aria-selected', String(isActive));
            });
            if (view !== 'code') {
                updatePreview();
            }
        }

        function injectBaseTag(html) {
            if (!html) return '';
            if (/<base\s/i.test(html)) return html;
            if (/<head[^>]*>/i.test(html)) {
                return html.replace(/<head([^>]*)>/i, '<head$1><base href="/site-assets/">');
            }
            return `<base href="/site-assets/">${html}`;
        }

        let previewTimer;
        function updatePreview() {
            if (!previewFrame || !htmlInput) return;
            const raw = htmlInput.value || '';
            const withBase = injectBaseTag(raw);
            previewFrame.srcdoc = withBase;
        }

        editorTabs.forEach(tab => {
            tab.addEventListener('click', () => setEditorView(tab.dataset.editorView));
        });

        if (htmlInput) {
            htmlInput.addEventListener('input', () => {
                if (editorContainer?.dataset.view === 'code') return;
                clearTimeout(previewTimer);
                previewTimer = setTimeout(updatePreview, 400);
            });
        }

        if (refreshBtn) {
            refreshBtn.addEventListener('click', updatePreview);
        }

        setEditorView('code');

        async function loadPageImages() {
            if (!pageImageGrid) return;
            pageImageGrid.innerHTML = 'Loading images...';
            try {
                const response = await fetch('/api/images/list');
                const images = await response.json();
                if (!Array.isArray(images) || images.length === 0) {
                    pageImageGrid.innerHTML = '<p>No images uploaded yet.</p>';
                    return;
                }

                pageImageGrid.innerHTML = images.map(image => `
                    <div class="image-card">
                        <div class="image-wrapper">
                            <img src="${image.url}" alt="${image.filename}">
                        </div>
                        <div class="image-info">
                            <p class="image-name" title="${image.filename}">${image.filename}</p>
                            <div class="image-actions">
                                <button type="button" class="btn-icon" title="Insert"
                                    onclick="insertImageIntoEditor('${image.path}')">‚ûï</button>
                                <button type="button" class="btn-icon" title="Copy path"
                                    onclick="copyImagePath('${image.path}')">üìã</button>
                                <button type="button" class="btn-icon btn-danger" title="Delete"
                                    onclick="deletePageImage('${image.filename}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                pageImageGrid.innerHTML = '<p>Failed to load images.</p>';
            }
        }

        function insertImageIntoEditor(path) {
            if (!htmlInput) return;
            const snippet = `<img src="${path}" alt="">`;
            const start = htmlInput.selectionStart || 0;
            const end = htmlInput.selectionEnd || 0;
            const current = htmlInput.value || '';
            htmlInput.value = current.slice(0, start) + snippet + current.slice(end);
            htmlInput.selectionStart = htmlInput.selectionEnd = start + snippet.length;
            htmlInput.focus();
            updatePreview();
        }

        async function uploadPageImages(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            if (pageUploadProgress) pageUploadProgress.style.display = 'block';
            if (pageProgressFill) pageProgressFill.style.width = '0%';
            if (pageProgressText) pageProgressText.textContent = 'Uploading...';

            let completed = 0;
            const total = files.length;

            for (const file of files) {
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch('/api/images/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (!result.success) {
                        alert(`Failed to upload ${file.name}: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error uploading ${file.name}: ${error.message}`);
                }

                completed++;
                const percent = Math.round((completed / total) * 100);
                if (pageProgressFill) pageProgressFill.style.width = `${percent}%`;
                if (pageProgressText) pageProgressText.textContent = `Uploading... ${percent}%`;
            }

            if (pageProgressText) pageProgressText.textContent = 'Upload complete';
            if (pageImageUploadInput) pageImageUploadInput.value = '';
            loadPageImages();
        }

        function copyImagePath(path) {
            if (!navigator?.clipboard) {
                alert('Clipboard access not available.');
                return;
            }
            navigator.clipboard.writeText(path).then(() => {
                alert('‚úÖ Image path copied');
            }).catch(() => {
                alert('‚ùå Failed to copy image path');
            });
        }

        async function deletePageImage(filename) {
            if (!filename) return;
            if (!confirm('Delete this image? This cannot be undone.')) return;

            try {
                const response = await fetch(`/api/images/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (!result.success) {
                    alert('‚ùå Failed to delete image');
                    return;
                }
                loadPageImages();
            } catch (error) {
                alert('‚ùå Error deleting image: ' + error.message);
            }
        }

        if (pageImageUploadInput) {
            pageImageUploadInput.addEventListener('change', uploadPageImages);
        }

        loadPageImages();

        async function savePage() {
            const form = document.getElementById('pageForm');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            if (!data.filename) {
                alert('Please provide a filename.');
                return;
            }

            const mode = '<%= mode %>';
            const url = mode === 'create' ? '/api/pages' : `/api/pages/${data.filename}`;
            const method = mode === 'create' ? 'POST' : 'PUT';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Page saved successfully!');
                    window.location.href = '/pages';
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
    </script>
</body>

</html>